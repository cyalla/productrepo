name: Create GitHub Issue for Every Commit

on:
  push:
    branches:
      - '**'

jobs:
  create-issue:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 2  # Fetch last 2 commits to generate the diff

      - name: Set up Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Generate Diff for Last Commit
        id: generate_diff
        run: |
          git diff HEAD^ HEAD > diff.txt

      - name: Check Diff Content
        run: |
          cat diff.txt

      - name: Create GitHub Issue
        if: ${{ success() }}
        uses: peter-evans/create-issue-from-file@v4
        with:
          title: "Commit diff for ${{ github.sha }}"
          content-filepath: diff.txt
          labels: "commit-diff"
          token: ${{ secrets.GITHUB_TOKEN }}

